<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>스트레토 간편 발주</title>
    <style>
        @font-face { font-family: 'Ciutadella'; src: url('Ciutadella-Regular.otf') format('opentype'); }
        :root { --accent-blue: #2997ff; --bg-dark: #111; --card-bg: #1c1c1e; }
        
        body {
            margin: 0; padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Pretendard", sans-serif;
            background-color: #000; color: #f5f5f7;
            display: flex; justify-content: center; min-height: 100vh;
        }
        
        .container {
            width: 100%; max-width: 480px; padding: 20px; box-sizing: border-box;
            background: #000; display: flex; flex-direction: column;
        }

        /* 헤더 & 정보 영역 */
        header { margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 20px; }
        h2 { font-family: 'Ciutadella', sans-serif; margin: 0 0 5px 0; color: var(--accent-blue); }
        .client-info-box {
            background: var(--card-bg); padding: 15px; border-radius: 8px; margin-top: 15px;
            border: 1px solid #333; font-size: 0.9rem; color: #ccc;
        }
        .client-info-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .info-label { color: #666; }
        .info-value { font-weight: bold; color: white; text-align: right; }

        /* 제품 그리드 (섹션 구분) */
        .grid-section { margin-bottom: 30px; }
        .grid-title { font-size: 1.1rem; font-weight: bold; margin-bottom: 10px; color: #f5f5f7; border-left: 3px solid var(--accent-blue); padding-left: 10px; display: flex; align-items: center; justify-content: space-between; }
        .grid-desc { font-size: 0.75rem; color: #888; font-weight: normal; }
        
        .product-grid {
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;
        }
        .product-btn {
            background: var(--card-bg); border: 1px solid #333; color: white;
            padding: 15px 10px; border-radius: 8px; cursor: pointer; text-align: left;
            transition: 0.2s; display: flex; flex-direction: column; justify-content: space-between;
            height: 90px;
        }
        .product-btn:active { transform: scale(0.98); background: #333; }
        .p-name { font-weight: bold; font-size: 1rem; }
        .p-sub { font-size: 0.8rem; color: #666; margin-top: 5px; }
        
        /* 싱글 오리진 버튼 스타일 (약간 다르게) */
        .product-btn.single { border-color: #444; background: #222; }

        /* 장바구니 영역 */
        .cart-section {
            margin-top: 20px; background: #1a1a1a; border-radius: 12px; padding: 20px;
            border: 1px solid #333;
        }
        .cart-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 0; border-bottom: 1px solid #333;
        }
        .cart-item:last-child { border-bottom: none; }
        .cart-info { display: flex; flex-direction: column; }
        .cart-name { font-weight: bold; font-size: 0.95rem; }
        .cart-type { font-size: 0.75rem; color: #888; }
        
        .qty-control { display: flex; align-items: center; gap: 8px; }
        .qty-btn {
            width: 32px; height: 32px; border-radius: 50%; border: none;
            background: #333; color: white; font-weight: bold; cursor: pointer; font-size: 1.1rem;
        }
        .qty-val-box { width: 50px; text-align: center; }
        .qty-val { width: 100%; text-align: center; font-weight: bold; background: transparent; border: none; color: white; font-size: 1rem; }
        .qty-unit { font-size: 0.7rem; color: #888; display: block; text-align: center;}
        
        .del-btn { color: #ff453a; background: none; border: none; margin-left: 5px; cursor: pointer; padding: 5px; }

        /* 하단 고정 버튼 */
        .bottom-action {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(0,0,0,0.9); padding: 20px;
            border-top: 1px solid #333; text-align: center;
            display: flex; justify-content: center; z-index: 100;
        }
        .submit-btn {
            width: 100%; max-width: 440px; padding: 18px; 
            background: var(--accent-blue); color: white; border: none; 
            border-radius: 12px; font-size: 1.1rem; font-weight: bold; cursor: pointer;
        }
        .submit-btn:disabled { background: #444; color: #888; }

        /* 로그인 화면 */
        #login-section { text-align: center; margin-top: 100px; }
        .login-input {
            width: 100%; padding: 15px; margin-bottom: 10px; background: #222;
            border: 1px solid #333; color: white; border-radius: 8px; box-sizing: border-box;
        }
        .login-btn {
            width: 100%; padding: 15px; background: white; color: black; font-weight: bold;
            border: none; border-radius: 8px; cursor: pointer;
        }
        .hidden { display: none !important; }
        .date-picker {
            width: 100%; padding: 10px; background: #222; color: white; border: 1px solid #333;
            border-radius: 8px; margin-top: 5px; font-family: inherit;
        }
    </style>
</head>
<body>

    <div class="container">
        <div id="login-section">
            <h1 style="font-family: 'Ciutadella'; margin-bottom: 30px;">PARTNER LOGIN</h1>
            <input type="text" id="loginId" class="login-input" placeholder="아이디 (예: gongdeok)">
            <input type="password" id="password" class="login-input" placeholder="비밀번호">
            <button id="loginBtn" class="login-btn">로그인</button>
            <p id="login-msg" style="color: #ff453a; margin-top: 15px; font-size: 0.9rem;"></p>
        </div>

        <div id="order-section" class="hidden">
            <header>
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h2>NEW ORDER</h2>
                    <button id="logoutBtn" style="background:none; border:none; color:#666; cursor:pointer;">로그아웃</button>
                </div>
                
                <div class="client-info-box">
                    <div class="client-info-row">
                        <span class="info-label">업체명</span>
                        <span class="info-value" id="disp-name">로딩 중...</span>
                    </div>
                    <div class="client-info-row">
                        <span class="info-label">주소</span>
                        <span class="info-value" id="disp-address" style="font-weight:normal; font-size:0.8rem;">-</span>
                    </div>
                    <div style="margin-top: 10px; border-top: 1px solid #444; padding-top: 10px;">
                        <span class="info-label">주문 날짜</span>
                        <input type="date" id="orderDate" class="date-picker">
                    </div>
                </div>
            </header>

            <div class="grid-section">
                <div class="grid-title">
                    블렌드 (Blend)
                    <span class="grid-desc">1kg 단위</span>
                </div>
                <div class="product-grid" id="grid-blend">
                    </div>
            </div>

            <div class="grid-section">
                <div class="grid-title">
                    싱글 오리진 (Single)
                    <span class="grid-desc">최소 200g / 100g 단위</span>
                </div>
                <div class="product-grid" id="grid-single">
                    </div>
            </div>

            <div class="cart-section" id="cartSection" style="display:none;">
                <div style="font-weight:bold; margin-bottom:15px; color:var(--accent-blue); display:flex; justify-content:space-between;">
                    <span>주문 목록</span>
                    <span id="total-weight" style="color:#888; font-weight:normal; font-size:0.9rem;">0kg</span>
                </div>
                <div id="cartList"></div>
                <input type="text" id="orderNote" placeholder="요청사항 (선택)" style="width:100%; padding:10px; background:#222; border:1px solid #333; color:white; margin-top:15px; border-radius:6px; box-sizing:border-box;">
            </div>
            
            <div style="height: 100px;"></div> <div class="bottom-action">
                <button id="submitBtn" class="submit-btn" disabled>주문할 품목을 선택하세요</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ▼▼▼ [중요] 사장님 Firebase 키값 복사해서 여기에 넣으세요! ▼▼▼
        const firebaseConfig = {
            apiKey: "AIzaSyAUjfrQ-HVivBLggiOl8vvRZynala1qqyM",
  authDomain: "roastery-f3e2e.firebaseapp.com",
  projectId: "roastery-f3e2e",
  storageBucket: "roastery-f3e2e.firebasestorage.app",
  messagingSenderId: "79814680110",
  appId: "1:79814680110:web:86aa08fe0e273fed6649bf"
};
        // ▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- 데이터 정의 (타입 구분: Blend / Single) ---
        const products = [
            { name: "알토 블렌드 (Alto)", type: "Blend" },
            { name: "스트레토 블렌드 (Stretto)", type: "Blend" },
            { name: "구스토 블렌드 (Gusto)", type: "Blend" },
            { name: "디카페인 (Decaffeine)", type: "Single" }, // 디카페인은 보통 싱글로 취급
            { name: "에티오피아", type: "Single" },
            { name: "케냐", type: "Single" },
            { name: "과테말라", type: "Single" },
            { name: "콜롬비아", type: "Single" },
            { name: "르완다", type: "Single" },
            { name: "파푸아뉴기니", type: "Single" }
        ];

        let cart = []; 
        let currentClient = null;

        // --- 초기화 ---
        document.getElementById('orderDate').valueAsDate = new Date();
        renderProductGrids();

        // --- 로그인 로직 ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('login-section').classList.add('hidden');
                document.getElementById('order-section').classList.remove('hidden');
                
                try {
                    const q = query(collection(db, "clients"), where("email", "==", user.email));
                    const querySnapshot = await getDocs(q);
                    
                    if (!querySnapshot.empty) {
                        const docData = querySnapshot.docs[0].data();
                        currentClient = { id: querySnapshot.docs[0].id, ...docData };
                        document.getElementById('disp-name').innerText = currentClient.name;
                        document.getElementById('disp-address').innerText = currentClient.address || "-";
                    } else {
                        document.getElementById('disp-name').innerText = "등록되지 않은 거래처";
                        alert("관리자에게 문의하세요. (정보 미등록)");
                    }
                } catch (e) { console.error(e); }

            } else {
                document.getElementById('login-section').classList.remove('hidden');
                document.getElementById('order-section').classList.add('hidden');
                currentClient = null;
            }
        });

        document.getElementById('loginBtn').addEventListener('click', () => {
            const id = document.getElementById('loginId').value.trim();
            const pw = document.getElementById('password').value;
            const email = id.includes('@') ? id : id + "@stretto.com";
            
            signInWithEmailAndPassword(auth, email, pw).catch(err => {
                document.getElementById('login-msg').innerText = "아이디 또는 비밀번호를 확인하세요.";
            });
        });

        document.getElementById('logoutBtn').addEventListener('click', () => signOut(auth));

        // --- UI 렌더링 (구분해서 그리기) ---
        function renderProductGrids() {
            const blendGrid = document.getElementById('grid-blend');
            const singleGrid = document.getElementById('grid-single');

            blendGrid.innerHTML = products.filter(p => p.type === 'Blend').map(p => `
                <div class="product-btn" onclick="addToCart('${p.name}', 'Blend')">
                    <span class="p-name">${p.name}</span>
                    <span class="p-sub" style="color:var(--accent-blue)">블렌드</span>
                </div>
            `).join('');

            singleGrid.innerHTML = products.filter(p => p.type === 'Single').map(p => `
                <div class="product-btn single" onclick="addToCart('${p.name}', 'Single')">
                    <span class="p-name">${p.name}</span>
                    <span class="p-sub" style="color:#d97706">싱글 오리진</span>
                </div>
            `).join('');
        }

        // --- 장바구니 로직 (핵심 변경점) ---
        window.addToCart = (productName, type) => {
            const existing = cart.find(item => item.name === productName);
            
            if (existing) {
                // 이미 있으면 단위만큼 추가
                if (type === 'Single') {
                    // 소수점 연산 오류 방지 (0.2 + 0.1)
                    existing.qty = parseFloat((existing.qty + 0.1).toFixed(1));
                } else {
                    existing.qty += 1;
                }
            } else {
                // 없으면 신규 추가 (싱글은 0.2부터, 블렌드는 1부터)
                const initialQty = type === 'Single' ? 0.2 : 1;
                cart.push({ name: productName, qty: initialQty, type: type });
            }
            renderCart();
        };

        window.updateQty = (idx, direction) => {
            const item = cart[idx];
            // 단위 설정 (싱글: 0.1kg, 블렌드: 1kg)
            const step = item.type === 'Single' ? 0.1 : 1;
            // 최소값 설정 (싱글: 0.2kg, 블렌드: 1kg)
            const min = item.type === 'Single' ? 0.2 : 1;

            let newQty = item.qty + (step * direction);
            
            // 소수점 깔끔하게 처리
            newQty = parseFloat(newQty.toFixed(1));

            if (newQty < min) return; // 최소값 밑으로 안 내려감

            item.qty = newQty;
            renderCart();
        };

        window.removeItem = (idx) => {
            cart.splice(idx, 1);
            renderCart();
        };

        function renderCart() {
            const section = document.getElementById('cartSection');
            const list = document.getElementById('cartList');
            const btn = document.getElementById('submitBtn');
            const totalWeightEl = document.getElementById('total-weight');

            if (cart.length === 0) {
                section.style.display = 'none';
                btn.disabled = true;
                btn.innerText = "주문할 품목을 선택하세요";
                btn.style.background = "#444";
                return;
            }

            section.style.display = 'block';
            
            // 총 무게 계산
            const totalKg = cart.reduce((acc, item) => acc + item.qty, 0).toFixed(1);
            totalWeightEl.innerText = `총 ${totalKg}kg`;
            
            btn.disabled = false;
            btn.innerText = "주문 전송하기";
            btn.style.background = "var(--accent-blue)";

            list.innerHTML = cart.map((item, idx) => `
                <div class="cart-item">
                    <div class="cart-info">
                        <span class="cart-name">${item.name}</span>
                        <span class="cart-type">${item.type === 'Single' ? '싱글 (최소 200g)' : '블렌드 (1kg 단위)'}</span>
                    </div>
                    <div class="qty-control">
                        <button class="qty-btn" onclick="updateQty(${idx}, -1)">-</button>
                        <div class="qty-val-box">
                            <input type="text" class="qty-val" value="${item.qty}" readonly>
                            <span class="qty-unit">kg</span>
                        </div>
                        <button class="qty-btn" onclick="updateQty(${idx}, 1)">+</button>
                        <button class="del-btn" onclick="removeItem(${idx})">✕</button>
                    </div>
                </div>
            `).join('');
        }

        // --- 주문 전송 ---
        document.getElementById('submitBtn').addEventListener('click', async () => {
            if (!currentClient) return alert("거래처 정보가 없습니다. 다시 로그인해주세요.");
            if (!confirm("주문을 전송하시겠습니까?")) return;

            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.innerText = "전송 중...";

            const date = document.getElementById('orderDate').value;
            const note = document.getElementById('orderNote').value;

            try {
                const promises = cart.map(item => {
                    return addDoc(collection(db, "orders"), {
                        date: date,
                        clientId: currentClient.id,
                        clientName: currentClient.name,
                        productType: item.name,
                        amountKg: item.qty,
                        unitPrice: 0, 
                        note: note,
                        createdAt: serverTimestamp()
                    });
                });

                await Promise.all(promises);

                // 여기에 EmailJS나 텔레그램 알림 코드 추가 가능

                alert("✅ 주문이 완료되었습니다!");
                cart = [];
                renderCart();
                document.getElementById('orderNote').value = '';

            } catch (err) {
                console.error(err);
                alert("전송 실패. 관리자에게 문의하세요.");
                btn.disabled = false;
                btn.innerText = "다시 전송";
            }
        });
    </script>
</body>
</html>