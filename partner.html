<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìŠ¤íŠ¸ë ˆí†  ê°„í¸ ë°œì£¼</title>
    <style>
        /* === ê¸°ë³¸ ì„¤ì • === */
        @font-face { font-family: 'Ciutadella'; src: url('Ciutadella-Regular.otf') format('opentype'); }
        :root { --accent-blue: #2997ff; --bg-dark: #111; --card-bg: #1c1c1e; }
        
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Pretendard", sans-serif; background-color: #000; color: #f5f5f7; display: flex; justify-content: center; min-height: 100vh; }
        .container { width: 100%; max-width: 480px; padding: 20px; box-sizing: border-box; background: #000; display: flex; flex-direction: column; position: relative; }

        header { margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 20px; }
        h2 { font-family: 'Ciutadella', sans-serif; margin: 0 0 5px 0; color: var(--accent-blue); }
        .client-info-box { background: var(--card-bg); padding: 15px; border-radius: 8px; margin-top: 15px; border: 1px solid #333; font-size: 0.9rem; color: #ccc; }
        .client-info-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .info-label { color: #666; }
        .info-value { font-weight: bold; color: white; text-align: right; }
        
        .grid-section { margin-bottom: 30px; }
        .grid-title { font-size: 1.1rem; font-weight: bold; margin-bottom: 10px; color: #f5f5f7; border-left: 3px solid var(--accent-blue); padding-left: 10px; display: flex; align-items: center; justify-content: space-between; }
        .grid-desc { font-size: 0.75rem; color: #888; font-weight: normal; }
        
        .product-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        
        /* === ìƒí’ˆ ì¹´ë“œ ìŠ¤íƒ€ì¼ === */
        .product-btn { 
            position: relative;
            background: var(--card-bg); 
            border: 1px solid #333; 
            color: white; 
            padding: 15px; 
            border-radius: 12px; 
            cursor: pointer; 
            text-align: left; 
            transition: all 0.2s ease; 
            display: flex; 
            flex-direction: column; 
            justify-content: space-between; 
            height: 100px; 
        }
        .product-btn:active { transform: scale(0.96); }

        .product-btn.active {
            border: 2px solid var(--accent-blue);
            background: rgba(41, 151, 255, 0.15); 
            box-shadow: 0 0 15px rgba(41, 151, 255, 0.1);
        }

        .count-badge {
            position: absolute;
            top: 10px; right: 10px;
            background: var(--accent-blue);
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
            z-index: 5;
            animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex; align-items: center; gap: 4px;
        }

        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }
        
        .p-name { font-weight: bold; font-size: 1.05rem; line-height: 1.3; }
        .p-sub { font-size: 0.8rem; color: #888; margin-top: 5px; }
        
        .product-btn.active .p-name { color: var(--accent-blue); }
        .product-btn.active .p-sub { color: #ccc; }

        .product-btn.single { border-color: #444; background: #222; }
        .product-btn.single.active { border-color: #d97706; background: rgba(217, 119, 6, 0.15); }
        .product-btn.single.active .p-name { color: #fbbf24; }
        .single-badge { background: #d97706 !important; }

        /* === í”Œë¡œíŒ… ì¥ë°”êµ¬ë‹ˆ ìŠ¤íƒ€ì¼ === */
        .cart-section { 
            display: none;
            position: fixed;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%);
            width: 95%;
            max-width: 460px;
            
            background: rgba(28, 28, 30, 0.98);
            backdrop-filter: blur(10px);
            
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 0 20px;
            box-sizing: border-box;
            box-shadow: 0 -10px 30px rgba(0,0,0,0.8);
            z-index: 99;
            
            transition: all 0.3s ease;
            max-height: 50vh;
            overflow: hidden;
        }
        
        .cart-section.folded {
            max-height: 56px;
            overflow: hidden;
            padding-bottom: 0;
        }

        .cart-header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #333; 
            padding: 15px 0;
            position: sticky; top: 0; background: transparent;
            cursor: pointer;
        }
        
        .cart-toggle-icon {
            transition: transform 0.3s;
            font-size: 0.8rem;
            color: #888;
            margin-left: 8px;
        }
        
        .cart-section.folded .cart-toggle-icon { transform: rotate(180deg); }
        .cart-section.folded .cart-header { border-bottom: none; }

        .cart-body {
            padding-bottom: 20px;
            overflow-y: auto;
            max-height: calc(50vh - 60px);
        }

        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #333; }
        .cart-item:last-child { border-bottom: none; }
        .cart-info { display: flex; flex-direction: column; }
        .cart-name { font-weight: bold; font-size: 0.95rem; }
        .cart-type { font-size: 0.75rem; color: #888; }
        .qty-control { display: flex; align-items: center; gap: 8px; }
        .qty-btn { width: 32px; height: 32px; border-radius: 50%; border: none; background: #444; color: white; font-weight: bold; cursor: pointer; font-size: 1.1rem; }
        .qty-val-box { width: 50px; text-align: center; }
        .qty-val { width: 100%; text-align: center; font-weight: bold; background: transparent; border: none; color: white; font-size: 1rem; }
        .qty-unit { font-size: 0.7rem; color: #888; display: block; text-align: center;}
        .del-btn { color: #ff453a; background: none; border: none; margin-left: 5px; cursor: pointer; padding: 5px; }
        
        .bottom-action { position: fixed; bottom: 0; left: 0; right: 0; background: #000; padding: 15px; border-top: 1px solid #333; text-align: center; display: flex; justify-content: center; z-index: 100; }
        .submit-btn { width: 100%; max-width: 440px; padding: 18px; background: var(--accent-blue); color: white; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(41, 151, 255, 0.3); }
        .submit-btn:disabled { background: #333; color: #666; box-shadow: none; }
        
        #login-section { text-align: center; margin-top: 100px; }
        .login-input { width: 100%; padding: 15px; margin-bottom: 10px; background: #222; border: 1px solid #333; color: white; border-radius: 8px; box-sizing: border-box; }
        .login-btn { width: 100%; padding: 15px; background: white; color: black; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; }
        .hidden { display: none !important; }

        .date-picker { width: 100%; padding: 10px; background: #222; color: white; border: 1px solid #333; border-radius: 8px; margin-top: 5px; font-family: inherit; box-sizing: border-box; }
        
        .history-section { margin-top: 40px; border-top: 1px solid #333; padding-top: 30px; }
        .history-card { background: #151515; border-radius: 8px; padding: 15px; margin-bottom: 10px; border: 1px solid #222; display: flex; justify-content: space-between; align-items: center; }
        .h-date { font-size: 0.8rem; color: var(--accent-blue); font-weight: bold; margin-bottom: 2px;}
        .h-name { font-weight: bold; font-size: 1rem; }
        .h-detail { font-size: 0.85rem; color: #888; }
        .h-amount { font-weight: bold; font-size: 1.1rem; color: white; }
        .cancel-btn { background: #330000; border: 1px solid #660000; color: #ff453a; font-size: 0.8rem; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-left: 10px;}
        .cancel-btn.disabled { background: #222; border-color: #333; color: #666; cursor: not-allowed; }
    </style>
</head>
<body>

    <div class="container">
        <div id="login-section">
            <h1 style="font-family: 'Ciutadella'; margin-bottom: 30px;">PARTNER LOGIN</h1>
            <input type="text" id="loginId" class="login-input" placeholder="ì•„ì´ë”” (ì˜ˆ: gongdeok)">
            <input type="password" id="password" class="login-input" placeholder="ë¹„ë°€ë²ˆí˜¸">
            <button id="loginBtn" class="login-btn">ë¡œê·¸ì¸</button>
            <p id="login-msg" style="color: #ff453a; margin-top: 15px; font-size: 0.9rem;"></p>
        </div>

        <div id="order-section" class="hidden">
            <header>
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h2>NEW ORDER</h2>
                    <button id="logoutBtn" style="background:none; border:none; color:#666; cursor:pointer;">ë¡œê·¸ì•„ì›ƒ</button>
                </div>
                
                <div class="client-info-box">
                    <div class="client-info-row">
                        <span class="info-label">ì—…ì²´ëª…</span>
                        <span class="info-value" id="disp-name">ë¡œë”© ì¤‘...</span>
                    </div>
                    <div class="client-info-row">
                        <span class="info-label">ì£¼ì†Œ</span>
                        <span class="info-value" id="disp-address" style="font-weight:normal; font-size:0.8rem;">-</span>
                    </div>
                    <div style="margin-top: 10px; border-top: 1px solid #444; padding-top: 10px;">
                        <span class="info-label">ì£¼ë¬¸ ë‚ ì§œ</span>
                        <input type="date" id="orderDate" class="date-picker">
                    </div>
                </div>
            </header>

            <div class="grid-section">
                <div class="grid-title">ë¸”ë Œë“œ (Blend) <span class="grid-desc">1kg ë‹¨ìœ„</span></div>
                <div class="product-grid" id="grid-blend"></div>
            </div>
            <div class="grid-section">
                <div class="grid-title">ì‹±ê¸€ ì˜¤ë¦¬ì§„ (Single) <span class="grid-desc">ìµœì†Œ 200g / 100g ë‹¨ìœ„</span></div>
                <div class="product-grid" id="grid-single"></div>
            </div>

            <div class="history-section">
                <div class="grid-title" style="border-left-color: #666; color: #ccc;">
                    ìµœê·¼ ì£¼ë¬¸ ë‚´ì—­
                    <span class="grid-desc">ë¡œìŠ¤íŒ… ì „(ì˜¤ì „ 11ì‹œ)ê¹Œì§€ ì·¨ì†Œ ê°€ëŠ¥</span>
                </div>
                <div id="historyList">
                    <div style="text-align:center; padding: 20px; color:#444;">ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                </div>
            </div>

            <div style="height: 400px;"></div>

            <div class="cart-section" id="cartSection">
                <div class="cart-header" onclick="toggleCart()">
                    <div style="display:flex; align-items:center;">
                        <span style="font-weight:bold; color:var(--accent-blue);">í˜„ì¬ ë‹´ì€ ëª©ë¡</span>
                        <span class="cart-toggle-icon">â–¼</span>
                    </div>
                    <span id="total-weight" style="color:#fff; font-weight:bold;">0kg</span>
                </div>
                
                <div class="cart-body">
                    <div id="cartList"></div>
                    <input type="text" id="orderNote" placeholder="ìš”ì²­ì‚¬í•­ (ì˜ˆ: êµµê²Œ ê°ˆì•„ì£¼ì„¸ìš”)" style="width:100%; padding:12px; background:#333; border:1px solid #444; color:white; margin-top:15px; border-radius:8px; box-sizing:border-box;">
                </div>
            </div>

            <div class="bottom-action">
                <button id="submitBtn" class="submit-btn" disabled>ì£¼ë¬¸í•  í’ˆëª©ì„ ì„ íƒí•˜ì„¸ìš”</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, where, onSnapshot, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAUjfrQ-HVivBLggiOl8vvRZynala1qqyM",
            authDomain: "roastery-f3e2e.firebaseapp.com",
            projectId: "roastery-f3e2e",
            storageBucket: "roastery-f3e2e.firebasestorage.app",
            messagingSenderId: "79814680110",
            appId: "1:79814680110:web:86aa08fe0e273fed6649bf"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let products = [];
        let cart = []; 
        let currentClient = null;
        let historyUnsubscribe = null;

        document.getElementById('orderDate').valueAsDate = new Date();
        init();

        async function init() {
            await fetchProducts(); 
        }

        // DBì—ì„œ ìƒí’ˆ ê°€ì ¸ì˜¤ê¸° (ê°€ê²© ì •ë³´ í¬í•¨)
        async function fetchProducts() {
            try {
                const q = query(collection(db, "products"), where("showPartner", "==", true));
                const querySnapshot = await getDocs(q);
                
                products = querySnapshot.docs.map(doc => {
                    const data = doc.data();
                    let type = "Single";
                    if (data.category === "Blend") type = "Blend";
                    
                    return {
                        id: doc.id,
                        name: data.name,
                        type: type, 
                        badge: data.badge,
                        // ê¸°ë³¸ B2B ê°€ê²© (ì—†ìœ¼ë©´ ê¸°ì¡´ price ì‚¬ìš©)
                        basePrice: data.priceB2B || data.price || 0 
                    };
                });
                products.sort((a, b) => a.name.localeCompare(b.name));
            } catch (e) { console.error("ìƒí’ˆ ë¡œë“œ ì‹¤íŒ¨", e); }
        }

        // â˜… [í•µì‹¬] í•´ë‹¹ ê±°ë˜ì²˜ì— ë§ëŠ” ìƒí’ˆ ê°€ê²© ê²°ì • í•¨ìˆ˜ â˜…
        function getClientPrice(product) {
            if (!currentClient) return product.basePrice;

            // 1. ê±°ë˜ì²˜ íŠ¹ë³„ ë‹¨ê°€ê°€ ìˆëŠ”ì§€ í™•ì¸
            if (currentClient.customPrices && currentClient.customPrices[product.name]) {
                return currentClient.customPrices[product.name];
            }
            // 2. ì—†ìœ¼ë©´ ê¸°ë³¸ B2B ê°€ê²© ë¦¬í„´
            return product.basePrice;
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('login-section').classList.add('hidden');
                document.getElementById('order-section').classList.remove('hidden');
                
                try {
                    const q = query(collection(db, "clients"), where("email", "==", user.email));
                    const querySnapshot = await getDocs(q);
                    if (!querySnapshot.empty) {
                        const docData = querySnapshot.docs[0].data();
                        currentClient = { id: querySnapshot.docs[0].id, ...docData };
                        
                        document.getElementById('disp-name').innerText = currentClient.name;
                        
                        // ë©´ì„¸/ë¶€ê°€ì„¸ ë³„ë„ ì—¬ë¶€ í‘œì‹œ
                        let taxText = "";
                        if (currentClient.isTaxExempt) {
                            taxText = " (VAT ë³„ë„/ë©´ì„¸)";
                            document.getElementById('disp-name').innerHTML += `<span style="font-size:0.8rem; color:#ffcc00;">${taxText}</span>`;
                        }

                        document.getElementById('disp-address').innerText = currentClient.address || "-";
                        
                        // ë¡œê·¸ì¸ í–ˆìœ¼ë‹ˆ ê°€ê²©ì„ ë°˜ì˜í•˜ì—¬ ìƒí’ˆ ë¦¬ìŠ¤íŠ¸ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
                        renderProductGrids(); 
                        loadOrderHistory(currentClient.id);
                    } else {
                        document.getElementById('disp-name').innerText = "ë¯¸ë“±ë¡ ê±°ë˜ì²˜";
                        alert("ê´€ë¦¬ì ë¬¸ì˜ í•„ìš”");
                    }
                } catch (e) { console.error(e); }
            } else {
                document.getElementById('login-section').classList.remove('hidden');
                document.getElementById('order-section').classList.add('hidden');
                currentClient = null;
                cart = []; // ë¡œê·¸ì•„ì›ƒ ì‹œ ì¥ë°”êµ¬ë‹ˆ ì´ˆê¸°í™”
                renderCart();
                if(historyUnsubscribe) historyUnsubscribe();
            }
        });

        // (í…”ë ˆê·¸ë¨, ë§ˆê°ì‹œê°„ ê³„ì‚°, íˆìŠ¤í† ë¦¬ ë¡œì§ì€ ê¸°ì¡´ê³¼ ë™ì¼í•˜ë¯€ë¡œ ìƒëµí•˜ì§€ ì•Šê³  ìœ ì§€)
        async function sendTelegramNotification(message) {
            try {
                await fetch('/api/send-telegram', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: message })
                });
            } catch (err) {}
        }
        function calculateDeadline(createdDate) {
            let deadline = new Date(createdDate);
            deadline.setHours(11, 0, 0, 0); 
            if (createdDate >= deadline) { deadline.setDate(deadline.getDate() + 1); deadline.setHours(11, 0, 0, 0); }
            while (true) { const day = deadline.getDay(); if (day >= 1 && day <= 4) break; deadline.setDate(deadline.getDate() + 1); }
            return deadline;
        }
        function loadOrderHistory(clientId) {
            const historyList = document.getElementById('historyList');
            const q = query(collection(db, "orders"), where("clientId", "==", clientId));
            historyUnsubscribe = onSnapshot(q, (snapshot) => {
                const orders = snapshot.docs.map(doc => ({id: doc.id, ...doc.data(), created: doc.data().createdAt ? doc.data().createdAt.toDate() : new Date()}));
                orders.sort((a, b) => b.created - a.created);
                if (orders.length === 0) { historyList.innerHTML = '<div style="text-align:center; padding:20px; color:#444;">ì£¼ë¬¸ ë‚´ì—­ ì—†ìŒ</div>'; return; }
                const now = new Date();
                historyList.innerHTML = orders.map(order => {
                    const deadline = calculateDeadline(order.created);
                    const isCancelable = now < deadline && order.status !== 'done';
                    const productDetails = `${order.productType} ${order.amountKg}kg`;
                    const days = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
                    const deadlineStr = `${days[deadline.getDay()]}ìš”ì¼ 11:00`;
                    
                    // ì£¼ë¬¸ ë‚´ì—­ì—ë„ ê¸ˆì•¡ ì •ë³´ê°€ ìˆìœ¼ë©´ ì¢‹ê² ì§€ë§Œ, ì¼ë‹¨ ê¸°ì¡´ ìœ ì§€
                    return `
                    <div class="history-card">
                        <div>
                            <div class="h-date">${order.date}</div>
                            <div class="h-name">${order.productType}</div>
                            ${order.note ? `<div class="h-detail">ğŸ“ ${order.note}</div>` : ''}
                        </div>
                        <div style="display:flex; flex-direction:column; align-items:flex-end;">
                            <div class="h-amount" style="margin-bottom:5px;">${order.amountKg}kg</div>
                            ${isCancelable 
                                ? `<button class="cancel-btn" onclick="tryCancel('${order.id}', '${deadline.toISOString()}', '${productDetails}')">ì·¨ì†Œ ê°€ëŠ¥</button>`
                                : `<button class="cancel-btn disabled" onclick="showContactInfo('${deadlineStr}')">ì·¨ì†Œ ë¶ˆê°€</button>`
                            }
                        </div>
                    </div>
                `}).join('');
            });
        }
        window.tryCancel = async (id, dl, txt) => {
            if (new Date() >= new Date(dl)) return alert("ì‹œê°„ ì´ˆê³¼");
            if(confirm("ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { await deleteDoc(doc(db, "orders", id)); sendTelegramNotification(`ğŸš« ì·¨ì†Œ: ${currentClient.name} / ${txt}`); alert("ì·¨ì†Œë¨"); }
        };
        window.showContactInfo = (t) => alert(`ë§ˆê° ê¸°ì¤€: ${t}\në¬¸ì˜: 010-8679-0553`);

        // --- ë¡œê·¸ì¸ ë²„íŠ¼ ë“± ---
        document.getElementById('loginBtn').addEventListener('click', () => {
            const id = document.getElementById('loginId').value.trim();
            const pw = document.getElementById('password').value;
            const email = id.includes('@') ? id : id + "@stretto.com";
            signInWithEmailAndPassword(auth, email, pw).catch(() => document.getElementById('login-msg').innerText = "ë¡œê·¸ì¸ ì‹¤íŒ¨");
        });
        document.getElementById('logoutBtn').addEventListener('click', () => signOut(auth));
        window.toggleCart = () => document.getElementById('cartSection').classList.toggle('folded');

        // --- â˜… ìƒí’ˆ ëª©ë¡ ë Œë”ë§ (ê°€ê²© í‘œì‹œ ì¶”ê°€) â˜… ---
        function renderProductGrids() {
            const blendGrid = document.getElementById('grid-blend');
            const singleGrid = document.getElementById('grid-single');

            // ê³µí†µ ì¹´ë“œ ìƒì„± í•¨ìˆ˜
            const createCard = (p) => {
                const item = cart.find(c => c.name === p.name);
                const isActive = item ? 'active' : '';
                const badge = item ? `<div class="count-badge">âœ” ${item.qty}kg</div>` : '';
                const styleClass = p.type === 'Single' ? 'single' : '';
                const subColor = p.type === 'Single' ? '#d97706' : 'var(--accent-blue)';
                
                // ê°€ê²© ê²°ì • (ë¡œê·¸ì¸ ì „ì—ëŠ” ì•ˆë³´ì´ê±°ë‚˜ ê¸°ë³¸ê°€, ë¡œê·¸ì¸ í›„ì—” í• ì¸ê°€)
                const finalPrice = getClientPrice(p); 
                const priceText = finalPrice > 0 ? `${finalPrice.toLocaleString()}ì›` : 'ê°€ê²© ë¬¸ì˜';

                return `
                <div class="product-btn ${styleClass} ${isActive}" onclick="addToCart('${p.name}', '${p.type}')">
                    ${badge}
                    <div>
                        <span class="p-name">${p.name}</span>
                        <div class="p-sub" style="color:${subColor}">${p.type === 'Single' ? 'ì‹±ê¸€ ì˜¤ë¦¬ì§„' : 'ë¸”ë Œë“œ'}</div>
                    </div>
                    <div style="text-align:right; font-size:0.9rem; font-weight:bold; margin-top:5px; color:#fff;">
                        ${priceText}<span style="font-size:0.7rem; font-weight:normal; color:#888;"> /kg</span>
                    </div>
                </div>`;
            };

            blendGrid.innerHTML = products.filter(p => p.type === 'Blend').map(p => createCard(p)).join('');
            singleGrid.innerHTML = products.filter(p => p.type === 'Single').map(p => createCard(p)).join('');
        }

        window.addToCart = (productName, type) => {
            // ê°€ê²© ì°¾ê¸°
            const product = products.find(p => p.name === productName);
            const price = getClientPrice(product);

            const existing = cart.find(item => item.name === productName);
            if (existing) {
                if (type === 'Single') existing.qty = parseFloat((existing.qty + 0.1).toFixed(1));
                else existing.qty += 1;
            } else {
                const initialQty = type === 'Single' ? 0.2 : 1;
                cart.push({ name: productName, qty: initialQty, type: type, price: price });
            }
            renderCart();
            renderProductGrids(); 
        };

        window.updateQty = (idx, direction) => {
            const item = cart[idx];
            const step = item.type === 'Single' ? 0.1 : 1;
            const min = item.type === 'Single' ? 0.2 : 1;
            let newQty = parseFloat((item.qty + (step * direction)).toFixed(1));
            if (newQty < min) return;
            item.qty = newQty;
            renderCart();
            renderProductGrids();
        };

        window.removeItem = (idx) => { cart.splice(idx, 1); renderCart(); renderProductGrids(); };

        // --- â˜… ì¥ë°”êµ¬ë‹ˆ ë Œë”ë§ (ì´ì•¡ ê³„ì‚° ì¶”ê°€) â˜… ---
        function renderCart() {
            const section = document.getElementById('cartSection');
            const list = document.getElementById('cartList');
            const btn = document.getElementById('submitBtn');
            const totalWeightEl = document.getElementById('total-weight');

            if (cart.length === 0) {
                section.style.display = 'none';
                btn.disabled = true;
                btn.innerText = "ì£¼ë¬¸í•  í’ˆëª©ì„ ì„ íƒí•˜ì„¸ìš”";
                btn.style.background = "#333";
                return;
            }
            section.style.display = 'block'; 

            // ì´ ë¬´ê²Œ ê³„ì‚°
            const totalKg = cart.reduce((acc, item) => acc + item.qty, 0).toFixed(1);
            
            // â˜… ì´ ê°€ê²© ê³„ì‚° â˜…
            const totalPrice = cart.reduce((acc, item) => acc + (item.price * item.qty), 0);
            const totalPriceStr = Math.floor(totalPrice).toLocaleString();

            // ìƒë‹¨ í‘œì‹œ (ë¬´ê²Œ / ê°€ê²©)
            totalWeightEl.innerHTML = `${totalKg}kg <span style="margin-left:8px; color:#ddd;">|</span> <span style="margin-left:8px; color:var(--accent-blue);">${totalPriceStr}ì›</span>`;

            // ë²„íŠ¼ í…ìŠ¤íŠ¸
            btn.disabled = false;
            btn.innerHTML = `${totalPriceStr}ì› ì£¼ë¬¸ ì „ì†¡í•˜ê¸°`;
            btn.style.background = "var(--accent-blue)";

            // ë©´ì„¸ ì•ˆë‚´ ë¬¸êµ¬
            let vatInfo = "";
            if (currentClient && currentClient.isTaxExempt) {
                vatInfo = `<div style="text-align:right; font-size:0.8rem; color:#ffcc00; margin-bottom:10px;">â€» ë¶€ê°€ì„¸ ë³„ë„ (ë©´ì„¸) ê¸ˆì•¡ì…ë‹ˆë‹¤.</div>`;
            }

            list.innerHTML = vatInfo + cart.map((item, idx) => {
                const itemTotal = (item.price * item.qty).toLocaleString();
                return `
                <div class="cart-item">
                    <div class="cart-info">
                        <span class="cart-name">${item.name}</span>
                        <span class="cart-type">${item.price.toLocaleString()}ì›/kg Â· í•©ê³„: ${itemTotal}ì›</span>
                    </div>
                    <div class="qty-control">
                        <button class="qty-btn" onclick="updateQty(${idx}, -1)">-</button>
                        <div class="qty-val-box"><input type="text" class="qty-val" value="${item.qty}" readonly><span class="qty-unit">kg</span></div>
                        <button class="qty-btn" onclick="updateQty(${idx}, 1)">+</button>
                        <button class="del-btn" onclick="removeItem(${idx})">âœ•</button>
                    </div>
                </div>`;
            }).join('');
        }

        // --- ì£¼ë¬¸ ì „ì†¡ ---
        document.getElementById('submitBtn').addEventListener('click', async () => {
            if (!currentClient) return alert("ì˜¤ë¥˜: ê±°ë˜ì²˜ ì •ë³´ ì—†ìŒ");
            
            // ì´ì•¡ ë‹¤ì‹œ ê³„ì‚°
            const totalPrice = cart.reduce((acc, item) => acc + (item.price * item.qty), 0);
            const totalPriceStr = Math.floor(totalPrice).toLocaleString();
            
            if (!confirm(`ì´ ê²°ì œ ì˜ˆì • ê¸ˆì•¡: ${totalPriceStr}ì›\nì£¼ë¬¸ì„ ì „ì†¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            
            const btn = document.getElementById('submitBtn');
            btn.disabled = true; btn.innerText = "ì „ì†¡ ì¤‘...";
            const date = document.getElementById('orderDate').value;
            const note = document.getElementById('orderNote').value;

            try {
                const promises = cart.map(item => {
                    return addDoc(collection(db, "orders"), {
                        date: date,
                        clientId: currentClient.id,
                        clientName: currentClient.name,
                        productType: item.name,
                        amountKg: item.qty,
                        unitPrice: item.price,    // ë‹¨ê°€ ì €ì¥
                        totalPrice: item.price * item.qty, // í•©ê³„ ì €ì¥
                        note: note, status: 'new', createdAt: serverTimestamp()
                    });
                });
                await Promise.all(promises);

                const orderDetails = cart.map(item => `- ${item.name}: ${item.qty}kg (${(item.price * item.qty).toLocaleString()}ì›)`).join('\n');
                const message = `ğŸ”” [ì‹ ê·œ ì£¼ë¬¸]\nğŸ‘¤ ${currentClient.name}\nğŸ“… ${date}\nğŸ’° ì´ì•¡: ${totalPriceStr}ì›\nğŸ“ ${note || 'ì—†ìŒ'}\n\nğŸ“¦ ë‚´ì—­:\n${orderDetails}`;
                sendTelegramNotification(message);

                alert("âœ… ì£¼ë¬¸ ì™„ë£Œ!");
                cart = []; renderCart(); renderProductGrids(); 
                document.getElementById('orderNote').value = ''; btn.disabled = false;
            } catch (err) { console.error(err); alert("ì „ì†¡ ì‹¤íŒ¨"); btn.disabled = false; }
        });
    </script>
</body>
</html>